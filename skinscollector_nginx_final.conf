server { 
    listen 80; 
    listen [::]:80; 
    server_name skinscollector.com www.skinscollector.com; 
    return 301 https://$host:8443$request_uri; 
} 

server { 
    listen 8443 ssl; 
    listen [::]:8443 ssl; 
    server_name skinscollector.com www.skinscollector.com; 

    root /var/www/skinscollector/public; 
    index index.php index.html; 

    # SSL
    ssl_certificate /etc/letsencrypt/live/skinscollector.com/fullchain.pem; 
    ssl_certificate_key /etc/letsencrypt/live/skinscollector.com/privkey.pem; 
    ssl_protocols TLSv1.2 TLSv1.3; 
    ssl_session_cache shared:SSL:10m; 
    ssl_session_timeout 10m; 

    # Security headers 
    add_header X-Frame-Options "SAMEORIGIN" always; 
    add_header X-Content-Type-Options "nosniff" always; 
    add_header Referrer-Policy "strict-origin-when-cross-origin" always; 

    charset utf-8; 

    # =========================================
    # ðŸš€ OPTIMIZATION SETTINGS ADDED BY AGENT
    # =========================================
    
    # 1. Increase Upload Limit (Fixes large image errors)
    client_max_body_size 64M;
    client_body_buffer_size 32M;

    # 2. Dedicated Storage Block (Highest Priority for Speed)
    # Serves files directly from /storage/ without hitting Laravel
    location ^~ /storage/ {
        try_files $uri $uri/ =404;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        log_not_found off;
    }

    # =========================================

    # Main Laravel routing 
    location / { 
        try_files $uri $uri/ /index.php?$query_string; 
    } 

    # General Static assets (images / css / js FAST) 
    location ~* \.(jpg|jpeg|png|gif|webp|svg|css|js|woff2|woff|ttf|ico)$ { 
        expires 365d; 
        add_header Cache-Control "public, immutable"; 
        access_log off; 
        log_not_found off; 
    } 

    # PHP 8.4 handler 
    location ~ \.php$ { 
        include fastcgi_params; 
        fastcgi_pass unix:/var/run/php/php8.4-fpm.sock; 
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name; 

        fastcgi_buffer_size 32k; 
        fastcgi_buffers 16 16k; 
        fastcgi_read_timeout 60s; 
    } 

    # Block hidden files 
    location ~ /\.(?!well-known).* { 
        deny all; 
        access_log off; 
        log_not_found off; 
    } 
}